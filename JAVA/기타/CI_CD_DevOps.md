# CI/CD DevOps는 무엇일까

## CI 
`CI (Continuous Integration) - 지속적 통합`

- 코드를 메인브랜치에 합치고, 합칠 때마다 자동으로 빌드하고 테스트 하는 것.

### 그래서 왜 필요한건데?
1. 통합지옥
    ```text 
    개발자 A: 2주 동안 기능 개발
    개발자 B: 2주 동안 다른 기능 개발
    개발자 C: 2주 도안 또 다른 기능 개발

    2주 후 코드 합치기 시도

    -> 충돌
    -> 빌드 안됨
    -> 테스트 깨짐
    merge 지옥에 빠져버림..
    ```
2. 내 컴퓨터에선 되는데요?
   ```text
    개발자: "로컬에서는 잘 동작해서 푸시 했어요"
    -> 실제 서버에 올리니 빌드 실패
    -> 운영 환경 배포 지연 
    ```
3. 테스트를 안하는 상황
    ```text
    급해서 테스트를 안 돌리고 올림
    -> 배포
    -> 버그 발생 
    -> 긴급 롤백 및 고객 불만 점검 동안 손해
    ```
   
### 이런 상황들에 CI가 있다면?
- 자동빌드
- 매일 코드 합침
- 충돌 생기면 바로 발견
- 푸시후 빌드 결과 확인 가능
- 자동으로 테스트 강제 실행
- 테스트 실패하면 merge 불가
- 품질 보장
- 매 커밋마다 체크
- 빠른 원인 분석

## CD
`CD (Continuous deployment) - 지속적 배포`
- CI에서 테스트 통과한 코드를 실제 서버에 배포하는 것을 자동화 하는 것

### CI vs CD 차이
CI: 
 - 코드 합치고 테스트까지

CD: 
 - 테스트 통과한 코드를 배포

#### CD의 대표적 배포 전략
1. Rolling Deployment(순차 배포)
    ```text
    서버1 업데이트 -> 서버2 업데이트 -> 서버3 업데이트
    ```

    *장점*
    - 구현이 가장 간단
      - 리소스 효율적 
        - 기존 서버만 사용
        - 추가 비용 없음
      - 점진적 배포
        - 핸다씩 업에디트 하니 전체 장애 위협 낮음
    
    *단점*
    - 버전 혼재
      - 배포 도중 사용자 마다 다른경험
      - API 호환성 문제가 있을 수 있음
      - 롤백이 복잡함
        - 다시 구버전으로 순차배포 해야함
        - 시간 오래 걸림
      - 배포 중 문제 발견 시 피해
        - 중간에 다른 서버는 이미 새 버전으로 바뀜
        - 이루 사용자 버그 경험

    *언제 쓸까?*
    - 소규모 서비스
      - 하위 호환성 보장되는 업데이트
      - 리소스가 제한적일 경우
   
2. Blue-Green Deployment
    ```text
    Blue (현재 버전) <- 사용자들
    Green (새 버전) <- 배포 후 테스트
    
    확인 완료 후
    Blue -> Green 사용자 트래픽 전환
   
    문제 있을 시 Blue로 즉시 복귀
    ```
   
*장점*
- 즉시 롤백 가능
  - 문제 발견 시 트래픽을 다시 Blue로 전환
  - 버전 혼재 없음
- 모든 사용자가 동일한 버전 사용
- API 호환성 걱정없음
  - 운영 환경과 동일한 환경에서 검증
- 무중단 배포
   

*단점*
   - 인프라 비용 2배
     - 서버가 5대 일 경우 10대 필요...
     - 비용 증가
   - 데이터베이스 동기화 문제
     - Blue DB와 Green DB를 어떻게 처리해야 할 지 고민해야함
       - 공유하면 DB 스키마 변경 시 문제
       - 분리하면 데이터 동기화 복잡

*언제 쓸까?*
- 대규모 서비스
- 롤백 속도가 중요한 경우
- 인프라 비용 감당 가능한 경우

3. Canary Deployment (카나리 배포)
    ```text
   사용자 5% -> 새버전 
   문제 없으면 25% -> 새버전
   문제 없으면 50% -> 새버전
   최종 100% -> 새버전
    ```

*장점*
- 위험 최소화
- 실제 운영환경에서 검증
- 점진적 확대
- A/B 테스트 가능
  - 새 기능 반응 확인
  - 데이터 기반 의사결정 

*단점*
- 복잡한 트래픽 관리
- 배포 시간이 김
- 모니터링 필수
- 버전 혼재 기간 길어짐

*언제 쓰나?*
- 대규모 서비스
- 리스크가 큰 업데이트
- 새로운 기능의 영향도 확인 필요

#### 아니 Blue/Green과 Canary를 두고 봤을 때 같은 대규모 서비스를 배포한다면 굳이 카나리를 선택할 필요가 없을 것 같은데?

`핵심은 Blue-Green은 어쨌든 전체를 한 번에 바꾸는거고, 카나리는 조금씩 섞어가며 바꾸는 것이다.`

그렇다면 카나리를 선택하는 이유가 대체 무엇일까?
1. 심각한 버그 소수에게만 노출
   - Green환경에서 치명적 버그를 반견하지 못 하면 유저 전체가 버그를 경험하고 피해를 입게 된다.
   - Canary환경은 소수 유저만 사용하여 짧은 시간내에 문제를 발견하고 즉시 중단할 수 있기 때문에 피해범위가 최소화 된다.


## DevOps
`DevOps (Development Operations)`
- 개발과 운영을 통합하는 문화
- 자동화, 협업, 빠른 피드백이 핵심
- CI/CD는 DevOps의 일부 도구

### 목표
- 빠르고 안정적인 배포
- 지속적인 개선

### 그래서 왜 그렇게 해야해?
```text
실제로 이전 회사에서 개발팀 팀장님과 운영팀 팀장님이
우리는 된다 -> 운영환경에선 안된다 -> 서버 잘못이다 -> 코드 잘못이다로 하루 종일 해결은 안하고 싸우기만 한 적이 있음 
```

- 기능 만들고 + 배포하고 + 모니터링하고 + 장애 대응
  - 기능 만들고 던지는게 아닌 자신이 운영하게 바뀜